<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Entregas • Mobile 9:16</title>
  <style>
    :root{
      --bg:#0b0c10;
      --text:#f4f7ff;
      --muted:#a7afbf;
      --panel:#121622;
      --card:#181d2a;
      --border:#232733;
      --accent:#4da3ff;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html, body { height: 100%; }
    body{
      margin:0;
      background: #0b0c10;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App shell 9:16 */
    .app{
      height: 100dvh;
      max-width: 480px;  /* nice on phone, centered if viewed on desktop */
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: radial-gradient(1200px 800px at 10% -10%, #0f1322, #0b0c10);
    }
    header{
      position: sticky; top: 0;
      padding: calc(8px + var(--safe-top)) 14px 10px;
      border-bottom: 1px solid #151a26;
      background: linear-gradient(180deg, #101428, #0c0f1a 70%);
      z-index: 5;
    }
    header h1{
      margin:0; font-size: 18px;
    }
    header .sub{ color: var(--muted); font-size: 13px; margin-top: 4px }

    main{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px 14px 12px;
    }
    .card{
      background: linear-gradient(180deg, #202736, #1a2030);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .section-title{ font-size: 14px; color: var(--muted); margin: 2px 2px 8px }

    .kpi{
      display:grid; gap:8px;
      grid-template-columns: 1fr 1fr;
    }
    .kpi .card{ padding: 10px }
    .kpi h3{ margin:0; font-size:12px; color:var(--muted) }
    .kpi .value{ margin-top:4px; font-size:20px; font-weight:700; font-variant-numeric: tabular-nums }

    .controls{
      display:grid; grid-template-columns: 1fr 1fr; gap:8px;
      margin-top: 8px;
    }
    .controls .group{ display:flex; gap:8px }
    select, input[type="number"]{
      width:100%; padding: 12px;
      font-size:16px; border-radius:12px;
      border:1px solid var(--border);
      background:#0f131d; color: var(--text);
    }

    /* Table */
    table{ width:100%; border-collapse:collapse; margin-top:8px; border-radius: 12px; overflow:hidden }
    thead th{
      position: sticky; top: 0;
      background:#151b2a; border-bottom:1px solid #20263a;
      text-align:left; padding:10px; font-size:12px; color:var(--muted);
      z-index: 2;
    }
    tbody td{ padding:8px 10px; border-bottom:1px solid #161c2a; font-size: 15px }
    tbody tr:nth-child(odd){ background: rgba(255,255,255,0.03) }
    input[type="number"]{ text-align:right }
    .right{ text-align:right }
    .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
    .muted{ color: var(--muted) }
    .today{ outline:2px solid var(--accent); outline-offset:-2px; border-radius: 8px }

    tfoot td{ padding: 12px 10px; font-weight:700; background:#141a27; border-top:1px solid #20263a }

    .progress{ height: 10px; background:#0f141f; border:1px solid #1a2233; border-radius:999px; overflow:hidden }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #7cc4ff); transition: width .25s ease }

    /* Fixed bottom action bar (always visible) */
    .actionbar{
      position: sticky; bottom: 0; z-index: 6;
      background: rgba(8,10,16,0.9);
      backdrop-filter: blur(8px);
      border-top: 1px solid #151a26;
      padding: 8px 12px calc(8px + var(--safe-bottom));
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .actionbar button{
      padding: 14px; font-size: 16px; font-weight:700; border-radius: 12px;
      border:1px solid var(--border); color:#fff;
    }
    .btn-secondary{ background: linear-gradient(180deg, #27334c, #1a2336) }
    .btn-primary{ background: linear-gradient(180deg, #2a63ff, #1e49c1); border: none }

    /* PRINT */
    @media print {
      @page { size: A4 portrait; margin: 14mm; }
      body{ background:#fff; color:#000 }
      header, .actionbar { display:none !important }
      main{ padding:0 }
      .print-area{ display:block !important }
      .print-area h2{ margin:0 0 6px 0; font-size:18px }
      .print-meta{ font-size:12px; margin-bottom:8px }
      .print-kpi{ display:grid; grid-template-columns: repeat(3,1fr); gap:6px; margin:8px 0 12px }
      .print-kpi > div{ border:1px solid #000; padding:6px 8px }
      .print-kpi h4{ margin:0 0 4px 0; font-size:12px }
      .print-kpi .value{ font-weight:700; font-size:14px }
      .print-table{ width:100%; border-collapse:collapse; font-size:11.5px }
      .print-table th, .print-table td{ border:1px solid #000; padding:6px 6px }
      .print-table tfoot td{ font-weight:700 }
    }
    .print-area{ display:none }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Entregas (9:16)</h1>
      <div class="sub">Use no telemóvel em modo retrato. Barra inferior com botões sempre visível.</div>
    </header>

    <main>
      <section class="card">
        <div class="section-title">Resumo</div>
        <div class="kpi">
          <div class="card">
            <h3>Total Entregue</h3>
            <div class="value mono" id="k_total">0</div>
          </div>
          <div class="card">
            <h3>Faltam p/ Meta</h3>
            <div class="value mono" id="k_faltam">3 000</div>
          </div>
          <div class="card">
            <h3>Bruto</h3>
            <div class="value mono" id="k_bruto">€ 0,00</div>
          </div>
          <div class="card">
            <h3>Combustível</h3>
            <div class="value mono" id="k_comb">€ 0,00</div>
          </div>
          <div class="card">
            <h3>Líquido</h3>
            <div class="value mono" id="k_liquido">€ 0,00</div>
          </div>
          <div class="card">
            <h3>Progresso</h3>
            <div class="progress" style="margin-top:6px"><div class="bar" id="bar"></div></div>
            <div class="right mono" id="pct" style="margin-top:4px">0%</div>
          </div>
        </div>

        <div class="controls">
          <div class="group">
            <select id="mes"></select>
            <select id="ano"></select>
          </div>
          <div class="group">
            <input type="number" id="unitario" min="0" step="0.01" value="1.20" aria-label="Valor por Unidade" />
            <input type="number" id="meta" min="0" step="1" value="3000" aria-label="Meta de Caixas" />
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <div class="section-title">Registo Diário</div>
        <table id="tabela">
          <thead>
            <tr>
              <th>Dia</th>
              <th>Caixas</th>
              <th class="right">Valor (€)</th>
              <th>Combustível (€)</th>
              <th class="right">Líquido (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td><span class="muted">Totais</span></td>
              <td class="right mono" id="totalCaixas">0</td>
              <td class="right mono" id="totalValor">€ 0,00</td>
              <td class="right mono" id="totalComb">€ 0,00</td>
              <td class="right mono" id="totalLiquido">€ 0,00</td>
            </tr>
          </tfoot>
        </table>
      </section>
    </main>

    <div class="actionbar">
      <button class="btn-secondary" id="exportar">CSV</button>
      <button class="btn-primary" id="imprimir">Imprimir PDF</button>
    </div>
  </div>

  <!-- Print area (built dynamically) -->
  <div class="print-area" id="printArea">
    <h2 id="p_title">Entregas do Mês</h2>
    <div class="print-meta" id="p_meta"></div>
    <div class="print-kpi" id="p_kpi"></div>
    <table class="print-table" id="p_table">
      <thead>
        <tr>
          <th>Dia</th><th>Caixas</th><th>Valor (€)</th><th>Combustível (€)</th><th>Líquido (€)</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td><strong>TOTAIS</strong></td>
          <td id="p_t_cx"></td>
          <td id="p_t_val"></td>
          <td id="p_t_comb"></td>
          <td id="p_t_liq"></td>
        </tr>
      </tfoot>
    </table>
  </div>

<script>
(function(){
  const EUR = new Intl.NumberFormat('pt-PT',{style:'currency', currency:'EUR'});
  const INT = new Intl.NumberFormat('pt-PT');

  const tbody = document.querySelector('#tabela tbody');
  const elTotalCaixas = document.getElementById('totalCaixas');
  const elTotalValor = document.getElementById('totalValor');
  const elTotalComb = document.getElementById('totalComb');
  const elTotalLiquido = document.getElementById('totalLiquido');

  const mesEl = document.getElementById('mes');
  const anoEl = document.getElementById('ano');
  const unitEl = document.getElementById('unitario');
  const metaEl = document.getElementById('meta');

  const exportar = document.getElementById('exportar');
  const imprimir = document.getElementById('imprimir');

  const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  meses.forEach((m,i)=>{
    const o=document.createElement('option'); o.value=i; o.textContent=m; mesEl.appendChild(o);
  });
  const now = new Date();
  const thisYear = now.getFullYear();
  for (let y=thisYear-3; y<=thisYear+3; y++){
    const o=document.createElement('option'); o.value=y; o.textContent=y; anoEl.appendChild(o);
  }
  mesEl.value = now.getMonth(); anoEl.value = now.getFullYear();

  function daysInMonth(m,y){ return new Date(y, m+1, 0).getDate(); }
  function storageKey(){ return `entregas:${anoEl.value}-${String(Number(mesEl.value)+1).padStart(2,'0')}`; }
  function loadData(){ const raw=localStorage.getItem(storageKey()); return raw?JSON.parse(raw):{}; }
  function saveData(obj){ localStorage.setItem(storageKey(), JSON.stringify(obj)); }
  function loadGlobals(){
    try{
      const x = JSON.parse(localStorage.getItem('entregas:globals')||'{}');
      if (typeof x.unit==='number') unitEl.value = x.unit;
      if (typeof x.meta==='number') metaEl.value = x.meta;
    }catch(e){}
  }
  function saveGlobals(){
    localStorage.setItem('entregas:globals', JSON.stringify({
      unit: Number(unitEl.value || 0),
      meta: Number(metaEl.value || 0),
    }));
  }

  function buildTable(){
    tbody.innerHTML='';
    const m = Number(mesEl.value), y = Number(anoEl.value);
    const n = daysInMonth(m,y);
    const data = loadData();
    const today = new Date();

    for (let d=1; d<=n; d++){
      const tr = document.createElement('tr');

      const tdDia = document.createElement('td');
      tdDia.textContent = String(d).padStart(2,'0');
      if (d===today.getDate() && m===today.getMonth() && y===today.getFullYear()){
        tdDia.classList.add('today');
      }

      const tdCx = document.createElement('td');
      const inpCx = document.createElement('input');
      inpCx.type='number'; inpCx.min='0'; inpCx.step='1'; inpCx.inputmode='numeric'; inpCx.placeholder='0';
      inpCx.value = (data[String(d)]?.cx ?? '');
      tdCx.appendChild(inpCx);

      const tdVal = document.createElement('td'); tdVal.className='right mono'; tdVal.textContent = EUR.format(0);

      const tdComb = document.createElement('td');
      const inpComb = document.createElement('input');
      inpComb.type='number'; inpComb.min='0'; inpComb.step='0.01'; inpComb.inputmode='decimal'; inpComb.placeholder='0,00';
      inpComb.value = (data[String(d)]?.comb ?? '');
      tdComb.appendChild(inpComb);

      const tdLiq = document.createElement('td'); tdLiq.className='right mono'; tdLiq.textContent = EUR.format(0);

      function persist(){
        const cx = inpCx.value===''?null:Number(inpCx.value);
        const comb = inpComb.value===''?null:Number(inpComb.value);
        const obj = loadData(); obj[String(d)] = {cx, comb}; saveData(obj);
      }
      function recalcRow(){
        const unit = Number(unitEl.value||0);
        const cx = Number(inpCx.value||0);
        const comb = Number(inpComb.value||0);
        const val = cx*unit; const liq = val - comb;
        tdVal.textContent = EUR.format(val);
        tdLiq.textContent = EUR.format(liq);
      }
      inpCx.addEventListener('input', ()=>{ persist(); recalcAll(); });
      inpComb.addEventListener('input', ()=>{ persist(); recalcAll(); });

      tr.appendChild(tdDia); tr.appendChild(tdCx); tr.appendChild(tdVal); tr.appendChild(tdComb); tr.appendChild(tdLiq);
      tbody.appendChild(tr);

      recalcRow();
    }
    recalcAll();
  }

  function recalcAll(){
    const unit = Number(unitEl.value||0);
    const meta = Number(metaEl.value||0);
    let tCx=0, tVal=0, tComb=0;
    const rows = Array.from(tbody.children);
    rows.forEach(tr=>{
      const cx = Number(tr.children[1].querySelector('input').value || 0);
      const comb = Number(tr.children[3].querySelector('input').value || 0);
      const val = cx*unit;
      const liq = val - comb;
      tCx += cx; tVal += val; tComb += comb;
      tr.children[2].textContent = EUR.format(val);
      tr.children[4].textContent = EUR.format(liq);
    });
    const tLiq = tVal - tComb;
    elTotalCaixas.textContent = INT.format(tCx);
    elTotalValor.textContent = EUR.format(tVal);
    elTotalComb.textContent = EUR.format(tComb);
    elTotalLiquido.textContent = EUR.format(tLiq);

    const faltam = Math.max(meta - tCx, 0);
    const pctVal = meta>0 ? Math.min(100, (tCx/meta)*100) : 0;
    document.getElementById('k_total').textContent = INT.format(tCx);
    document.getElementById('k_faltam').textContent = INT.format(faltam);
    document.getElementById('k_bruto').textContent = EUR.format(tVal);
    document.getElementById('k_comb').textContent = EUR.format(tComb);
    document.getElementById('k_liquido').textContent = EUR.format(tLiq);
    document.getElementById('bar').style.width = pctVal.toFixed(2)+'%';
    document.getElementById('pct').textContent = pctVal.toFixed(1)+'%';
  }

  // Persist global settings
  unitEl.addEventListener('input', ()=>{ saveGlobals(); recalcAll(); });
  metaEl.addEventListener('input', ()=>{ saveGlobals(); recalcAll(); });

  // React to month/year
  mesEl.addEventListener('change', ()=> buildTable());
  anoEl.addEventListener('change', ()=> buildTable());

  // CSV export
  exportar.addEventListener('click', ()=>{
    const m = Number(mesEl.value), y = Number(anoEl.value);
    const n = daysInMonth(m,y);
    const unit = Number(unitEl.value||0);
    let csv = 'Dia;Caixas;Valor do Dia (€);Combustível (€);Líquido do Dia (€)\n';
    let totalCx=0,totalVal=0,totalComb=0;
    for (let d=1; d<=n; d++){
      const tr = tbody.children[d-1];
      const cx = Number(tr.children[1].querySelector('input').value || 0);
      const comb = Number(tr.children[3].querySelector('input').value || 0);
      const val = cx*unit, liq = val - comb;
      totalCx+=cx; totalVal+=val; totalComb+=comb;
      csv += [d, cx, val.toFixed(2).replace('.',','), comb.toFixed(2).replace('.',','), liq.toFixed(2).replace('.',',')].join(';')+'\n';
    }
    const totalLiq = totalVal - totalComb;
    csv += ['TOTAL', totalCx, totalVal.toFixed(2).replace('.',','), totalComb.toFixed(2).replace('.',','), totalLiq.toFixed(2).replace('.',',')].join(';')+'\n';
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download=`Entregas_${y}_${String(m+1).padStart(2,'0')}.csv`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });

  // Print builder
  imprimir.addEventListener('click', ()=>{
    const m = Number(mesEl.value), y = Number(anoEl.value);
    const unit = Number(unitEl.value||0);
    const n = daysInMonth(m,y);
    const printArea = document.getElementById('printArea');
    const pTitle = document.getElementById('p_title');
    const pMeta = document.getElementById('p_meta');
    const pKpi = document.getElementById('p_kpi');
    const pBody = document.querySelector('#p_table tbody');
    const p_t_cx = document.getElementById('p_t_cx');
    const p_t_val = document.getElementById('p_t_val');
    const p_t_comb = document.getElementById('p_t_comb');
    const p_t_liq = document.getElementById('p_t_liq');

    const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    pTitle.textContent = `Entregas — ${meses[m]} de ${y}`;

    const meta = Number(metaEl.value||0);
    const totalCx = Array.from(tbody.children).reduce((acc,tr)=> acc + Number(tr.children[1].querySelector('input').value||0), 0);
    const totalVal = Array.from(tbody.children).reduce((acc,tr)=> acc + (Number(tr.children[1].querySelector('input').value||0) * unit), 0);
    const totalComb = Array.from(tbody.children).reduce((acc,tr)=> acc + Number(tr.children[3].querySelector('input').value||0), 0);
    const totalLiq = totalVal - totalComb;
    pMeta.textContent = `Valor por unidade: ${EUR.format(unit)} • Meta: ${INT.format(meta)} caixas • Progresso: ${(meta>0? (totalCx/meta*100):0).toFixed(1)}%`;

    pKpi.innerHTML='';
    [['Total Entregue', INT.format(totalCx)],
     ['Faltam p/ Meta', INT.format(Math.max(meta-totalCx,0))],
     ['Valor da Meta', EUR.format(meta*unit)],
    ].forEach(([k,v])=>{ const div=document.createElement('div'); div.innerHTML=`<h4>${k}</h4><div class="value">${v}</div>`; pKpi.appendChild(div); });

    pBody.innerHTML='';
    let sumCx=0,sumVal=0,sumComb=0;
    for (let d=1; d<=n; d++){
      const trDom = tbody.children[d-1];
      const cx = Number(trDom.children[1].querySelector('input').value||0);
      const comb = Number(trDom.children[3].querySelector('input').value||0);
      const val = cx*unit, liq = val - comb;
      sumCx+=cx; sumVal+=val; sumComb+=comb;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${String(d).padStart(2,'0')}</td>
                      <td class="right">${INT.format(cx)}</td>
                      <td class="right">${EUR.format(val)}</td>
                      <td class="right">${EUR.format(comb)}</td>
                      <td class="right">${EUR.format(liq)}</td>`;
      pBody.appendChild(tr);
    }
    p_t_cx.textContent = INT.format(sumCx);
    p_t_val.textContent = EUR.format(sumVal);
    p_t_comb.textContent = EUR.format(sumComb);
    p_t_liq.textContent = EUR.format(sumVal - sumComb);

    window.print();
  });

  // Helpers in scope for CSV/print
  function daysInMonth(m,y){ return new Date(y, m+1, 0).getDate(); }

  // Init
  loadGlobals();
  buildTable();
})();</script>
</body>
</html>
